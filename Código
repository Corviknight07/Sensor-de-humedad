#include <TFT_eSPI.h>
#include <DHT.h>

/* ========= DHT22 ========= */

#define DHTPIN 4

#define DHTTYPE DHT22

DHT dht(DHTPIN, DHTTYPE);

/* ========= SENSOR DE HUMEDAD ========= */

#define SOIL_PIN 34

#define SOIL_DRY 3000
#define SOIL_WET 1200

/* ========= PANTALLA ========= */

TFT_eSPI tft = TFT_eSPI();

/* ========= VARIABLES ========= */

float temperature = 0.0;
float humidity = 0.0;
int soilRaw = 0;

String soilState = "";

/* ========= SETUP ========= */

void setup() {

  Serial.begin(115200);

  dht.begin();

  tft.init();
  tft.setRotation(1);
  tft.fillScreen(TFT_BLACK);

  tft.setTextColor(TFT_WHITE, TFT_BLACK);
  tft.setTextSize(2);

  tft.drawString("Estado del Sistema", 10, 10, 2);
}

/* ========= LOOP ========= */

void loop() {

  /* ---- Lectura de sensores ---- */

  temperature = dht.readTemperature();

  humidity = dht.readHumidity();


  soilRaw = analogRead(SOIL_PIN);

  if (isnan(temperature) || isnan(humidity)) {
    return;
  }

  /* ---- Interpretacion del suelo ---- */

  if (soilRaw > 2400) {
    soilState = "SECA";
  }
  else if (soilRaw > 1700) {
    soilState = "MEDIA";
  }
  else {
    soilState = "HUMEDA";
  }

  /* ---- Actualizacion de pantalla ---- */

  tft.fillRect(0, 50, 320, 180, TFT_BLACK);

  tft.drawString("Temperatura:", 10, 60, 2);
  tft.drawFloat(temperature, 1, 200, 60, 2);
  tft.drawString("C", 270, 60, 2);

  tft.drawString("Suelo:", 10, 100, 2);
  tft.drawString(soilState, 200, 100, 2);


  tft.drawString("(", 200, 130, 2);
  tft.drawNumber(soilRaw, 215, 130, 2);
  tft.drawString(")", 285, 130, 2);

  /* ---- Mensajes por USB (opcional) ---- */
  Serial.print("Temp: ");
  Serial.print(temperature);
  Serial.print(" C | Suelo: ");
  Serial.print(soilState);
  Serial.print(" (");
  Serial.print(soilRaw);
  Serial.println(")");

  delay(2000);
}
